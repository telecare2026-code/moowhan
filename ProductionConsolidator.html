<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Data Consolidator - TMT Camera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap');
        * { font-family: 'IBM Plex Sans Thai', sans-serif; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-white">
    <div id="app"></div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        const state = {
            activeTab: 'upload',
            mainFile: null,
            mainWorkbook: null,
            sourceFiles: [],
            processing: false,
            processedData: null,
            summaryData: null,
            expandedSections: {},
            error: null
        };

        // ==================== UTILITY FUNCTIONS ====================
        const formatNumber = (num) => num?.toLocaleString() || '0';
        
        const categorizeFile = (filename) => {
            const name = filename.toUpperCase();
            if (name.startsWith('BP_') && !name.startsWith('BPK')) return 'BP';
            if (name.startsWith('BPK')) return 'BPK';
            if (name.startsWith('GW')) return 'GW';
            if (name.startsWith('SR')) return 'SR';
            return null;
        };

        const getCategoryColor = (cat) => ({
            'BP': 'bg-blue-500/20 text-blue-400 border-blue-500/50',
            'BPK': 'bg-green-500/20 text-green-400 border-green-500/50',
            'GW': 'bg-purple-500/20 text-purple-400 border-purple-500/50',
            'SR': 'bg-orange-500/20 text-orange-400 border-orange-500/50',
        }[cat] || 'bg-gray-500/20 text-gray-400 border-gray-500/50');

        const getCategoryBg = (cat) => ({
            'BP': 'from-blue-500 to-blue-600',
            'BPK': 'from-green-500 to-green-600',
            'GW': 'from-purple-500 to-purple-600',
            'SR': 'from-orange-500 to-orange-600',
        }[cat] || 'from-gray-500 to-gray-600');

        // ==================== EXCEL PROCESSING ====================
        const readExcelFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        };

        const extractDataFromSource = (workbook) => {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // Find header row (row 13, index 12)
            const headerRowIndex = 12;
            const dataStartIndex = 13;
            
            if (jsonData.length <= dataStartIndex) return [];
            
            const headers = jsonData[headerRowIndex] || [];
            const data = [];
            
            // Find column indices
            const colMap = {
                partNumber: 0,  // Column A
                partCode: 1,    // Column B
                partDesc: 2,    // Column C
                suppCode: 3,    // Column D
                shippingDock: 4, // Column E
                dockCode: 5,    // Column F
                carFamily: 6,   // Column G
                packingSize: 7, // Column H
            };

            // Find N, N+1, N+2, N+3 total columns
            let nCol = -1, n1Col = -1, n2Col = -1, n3Col = -1;
            headers.forEach((h, i) => {
                const val = String(h).trim().toUpperCase();
                if (val === 'N' && nCol === -1) nCol = i;
                else if (val === 'N+1' && n1Col === -1) n1Col = i;
                else if (val === 'N+2' && n2Col === -1) n2Col = i;
                else if (val === 'N+3' && n3Col === -1) n3Col = i;
            });

            // If not found by name, use position (columns 39, 71, 103, 135)
            if (nCol === -1) nCol = 39;
            if (n1Col === -1) n1Col = 71;
            if (n2Col === -1) n2Col = 103;
            if (n3Col === -1) n3Col = 135;

            for (let i = dataStartIndex; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || !row[0] || row[0] === '<EOF>') continue;
                
                const partNumber = String(row[colMap.partNumber] || '').trim();
                if (!partNumber || partNumber.length < 5) continue;

                data.push({
                    partNumber,
                    partCode: row[colMap.partCode] || '',
                    partDesc: row[colMap.partDesc] || '',
                    suppCode: row[colMap.suppCode] || '',
                    shippingDock: row[colMap.shippingDock] || '',
                    dockCode: row[colMap.dockCode] || '',
                    carFamily: row[colMap.carFamily] || '',
                    packingSize: row[colMap.packingSize] || 0,
                    n: Number(row[nCol]) || 0,
                    n1: Number(row[n1Col]) || 0,
                    n2: Number(row[n2Col]) || 0,
                    n3: Number(row[n3Col]) || 0,
                    rawRow: row.slice(0, 136) // Keep all columns for export
                });
            }
            
            return data;
        };

        const processAllFiles = async () => {
            state.processing = true;
            state.error = null;
            render();

            try {
                const processedData = {
                    'BP Daily': [],
                    'BPK Daily': [],
                    'GW Daily': [],
                    'SR Daily': []
                };

                // Process each source file
                for (const file of state.sourceFiles) {
                    try {
                        const workbook = await readExcelFile(file.file);
                        const data = extractDataFromSource(workbook);
                        const sheetName = `${file.category} Daily`;
                        
                        if (processedData[sheetName]) {
                            processedData[sheetName].push(...data);
                        }
                        
                        file.status = 'done';
                        file.rowCount = data.length;
                        render();
                    } catch (err) {
                        file.status = 'error';
                        file.error = err.message;
                        render();
                    }
                }

                state.processedData = processedData;

                // Calculate summary
                const summary = {};
                Object.entries(processedData).forEach(([sheet, rows]) => {
                    const plant = sheet.split(' ')[0];
                    rows.forEach(row => {
                        if (!summary[row.partNumber]) {
                            summary[row.partNumber] = { 
                                n: 0, n1: 0, n2: 0, n3: 0, 
                                plants: new Set(),
                                details: []
                            };
                        }
                        summary[row.partNumber].n += row.n;
                        summary[row.partNumber].n1 += row.n1;
                        summary[row.partNumber].n2 += row.n2;
                        summary[row.partNumber].n3 += row.n3;
                        summary[row.partNumber].plants.add(plant);
                        summary[row.partNumber].details.push({ ...row, plant });
                    });
                });

                state.summaryData = Object.entries(summary)
                    .map(([part, data]) => ({
                        partNumber: part,
                        plants: Array.from(data.plants).sort().join(', '),
                        n: data.n,
                        n1: data.n1,
                        n2: data.n2,
                        n3: data.n3,
                        details: data.details
                    }))
                    .sort((a, b) => a.partNumber.localeCompare(b.partNumber));

                state.activeTab = 'preview';
            } catch (err) {
                state.error = 'เกิดข้อผิดพลาดในการประมวลผล: ' + err.message;
            }

            state.processing = false;
            render();
        };

        const exportToExcel = () => {
            if (!state.processedData || !state.mainWorkbook) {
                // Create new workbook if no main file
                const wb = XLSX.utils.book_new();
                
                // Create Daily sheets
                Object.entries(state.processedData).forEach(([sheetName, data]) => {
                    if (data.length === 0) return;
                    
                    // Create header row
                    const headers = ['PART NUMBER', 'PART CODE', 'PART DESC', 'SUPP CODE', 
                                   'SHIPPING DOCK', 'DOCK CODE', 'CAR FAMILY', 'PACKING SIZE',
                                   'N', 'N+1', 'N+2', 'N+3'];
                    
                    const wsData = [headers];
                    data.forEach(row => {
                        wsData.push([
                            row.partNumber, row.partCode, row.partDesc, row.suppCode,
                            row.shippingDock, row.dockCode, row.carFamily, row.packingSize,
                            row.n, row.n1, row.n2, row.n3
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                // Create Summary sheet (Sheet2)
                if (state.summaryData) {
                    const summaryHeaders = ['Part Number', 'Sum of N', 'Sum of N+1', 'Sum of N+2', 'Sum of N+3', 'Plants'];
                    const summaryData = [summaryHeaders];
                    
                    state.summaryData.forEach(row => {
                        summaryData.push([row.partNumber, row.n, row.n1, row.n2, row.n3, row.plants]);
                    });
                    
                    // Add Grand Total
                    const totals = state.summaryData.reduce((acc, r) => ({
                        n: acc.n + r.n,
                        n1: acc.n1 + r.n1,
                        n2: acc.n2 + r.n2,
                        n3: acc.n3 + r.n3
                    }), { n: 0, n1: 0, n2: 0, n3: 0 });
                    
                    summaryData.push(['Grand Total', totals.n, totals.n1, totals.n2, totals.n3, '']);
                    
                    const ws = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Summary');
                }

                // Create Total sheet
                if (state.summaryData) {
                    const totalHeaders = ['Part', 'Plants', 'N (Feb)', 'N+1 (Mar)', 'N+2 (Apr)', 'N+3 (May)', 'Total'];
                    const totalData = [totalHeaders];
                    
                    state.summaryData.forEach(row => {
                        const total = row.n + row.n1 + row.n2 + row.n3;
                        totalData.push([row.partNumber, row.plants, row.n, row.n1, row.n2, row.n3, total]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(totalData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Total');
                }

                // Download
                const fileName = `Production_Summary_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
            } else {
                // Update existing workbook
                const wb = state.mainWorkbook;
                
                // Update Daily sheets
                Object.entries(state.processedData).forEach(([sheetName, data]) => {
                    if (!wb.Sheets[sheetName] || data.length === 0) return;
                    
                    const ws = wb.Sheets[sheetName];
                    const startRow = 14; // Data starts at row 14
                    
                    data.forEach((row, idx) => {
                        const rowNum = startRow + idx;
                        // Write columns A-I
                        XLSX.utils.sheet_add_aoa(ws, [[
                            row.partNumber, row.partCode, row.partDesc, row.suppCode,
                            row.shippingDock, row.dockCode, row.carFamily, row.packingSize
                        ]], { origin: `A${rowNum}` });
                        
                        // Write N totals at correct positions
                        if (row.rawRow) {
                            for (let c = 8; c < row.rawRow.length; c++) {
                                const cell = XLSX.utils.encode_cell({ r: rowNum - 1, c: c });
                                ws[cell] = { v: row.rawRow[c], t: typeof row.rawRow[c] === 'number' ? 'n' : 's' };
                            }
                        }
                    });
                });

                // Update Summary sheet
                if (state.summaryData && wb.Sheets['Sheet2']) {
                    const ws = wb.Sheets['Sheet2'];
                    state.summaryData.forEach((row, idx) => {
                        const rowNum = 4 + idx;
                        XLSX.utils.sheet_add_aoa(ws, [[
                            row.partNumber, row.n, row.n1, row.n2, row.n3
                        ]], { origin: `A${rowNum}` });
                    });
                }

                const fileName = `Production_Summary_Updated_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
            }
        };

        // ==================== EVENT HANDLERS ====================
        const handleMainFileSelect = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const workbook = await readExcelFile(file);
                state.mainFile = {
                    name: file.name,
                    size: (file.size / 1024).toFixed(1) + ' KB',
                    file: file,
                    sheets: workbook.SheetNames
                };
                state.mainWorkbook = workbook;
                state.error = null;
            } catch (err) {
                state.error = 'ไม่สามารถอ่านไฟล์หลักได้: ' + err.message;
            }
            render();
        };

        const handleSourceFilesSelect = (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const category = categorizeFile(file.name);
                if (category) {
                    // Check if already exists
                    if (!state.sourceFiles.find(f => f.name === file.name)) {
                        state.sourceFiles.push({
                            name: file.name,
                            size: (file.size / 1024).toFixed(1) + ' KB',
                            category,
                            file,
                            status: 'ready'
                        });
                    }
                }
            });
            render();
        };

        const removeSourceFile = (index) => {
            state.sourceFiles.splice(index, 1);
            render();
        };

        const toggleSection = (section) => {
            state.expandedSections[section] = !state.expandedSections[section];
            render();
        };

        const setActiveTab = (tab) => {
            state.activeTab = tab;
            render();
        };

        const resetAll = () => {
            state.mainFile = null;
            state.mainWorkbook = null;
            state.sourceFiles = [];
            state.processedData = null;
            state.summaryData = null;
            state.expandedSections = {};
            state.error = null;
            state.activeTab = 'upload';
            render();
        };

        // ==================== RENDER FUNCTIONS ====================
        const icons = {
            upload: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>`,
            file: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path stroke-width="2" d="M14 2v6h6M8 13h8M8 17h8"/></svg>`,
            check: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path stroke-width="2" d="M22 4L12 14.01l-3-3"/></svg>`,
            trash: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`,
            play: `<svg class="w-full h-full" fill="currentColor" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
            download: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>`,
            chart: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 3v18h18"/><path stroke-width="2" d="M18 17V9M13 17V5M8 17v-3"/></svg>`,
            eye: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3" stroke-width="2"/></svg>`,
            refresh: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M23 4v6h-6M1 20v-6h6"/><path stroke-width="2" d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>`,
            chevronDown: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 9l6 6 6-6"/></svg>`,
            chevronUp: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M18 15l-6-6-6 6"/></svg>`,
            alert: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path stroke-width="2" d="M12 8v4M12 16h.01"/></svg>`,
            reset: `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/><path stroke-width="2" d="M3 3v5h5"/></svg>`,
        };

        const render = () => {
            const app = document.getElementById('app');
            const { activeTab, mainFile, sourceFiles, processing, processedData, summaryData, error } = state;
            
            const fileCounts = {
                BP: sourceFiles.filter(f => f.category === 'BP').length,
                BPK: sourceFiles.filter(f => f.category === 'BPK').length,
                GW: sourceFiles.filter(f => f.category === 'GW').length,
                SR: sourceFiles.filter(f => f.category === 'SR').length,
            };

            const totals = summaryData ? summaryData.reduce((acc, r) => ({
                n: acc.n + r.n,
                n1: acc.n1 + r.n1,
                n2: acc.n2 + r.n2,
                n3: acc.n3 + r.n3
            }), { n: 0, n1: 0, n2: 0, n3: 0 }) : { n: 0, n1: 0, n2: 0, n3: 0 };

            app.innerHTML = `
                <!-- Header -->
                <header class="bg-slate-800/60 backdrop-blur-lg border-b border-slate-700 sticky top-0 z-50">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 p-2.5 bg-gradient-to-br from-emerald-400 to-cyan-500 rounded-xl shadow-lg shadow-emerald-500/20">
                                    ${icons.file}
                                </div>
                                <div>
                                    <h1 class="text-xl font-bold">Production Data Consolidator</h1>
                                    <p class="text-sm text-slate-400">TMT Camera Production Plan Summary</p>
                                </div>
                            </div>
                            <button onclick="resetAll()" class="flex items-center gap-2 px-4 py-2 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors">
                                <div class="w-4 h-4">${icons.reset}</div>
                                รีเซ็ต
                            </button>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto px-4 py-6">
                    <!-- Tabs -->
                    <div class="flex gap-2 mb-6">
                        <button onclick="setActiveTab('upload')" class="flex items-center gap-2 px-5 py-2.5 rounded-xl font-medium transition-all ${activeTab === 'upload' ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30' : 'bg-slate-700/50 text-slate-300 hover:bg-slate-700'}">
                            <div class="w-5 h-5">${icons.upload}</div>
                            อัปโหลดไฟล์
                        </button>
                        <button onclick="setActiveTab('preview')" class="flex items-center gap-2 px-5 py-2.5 rounded-xl font-medium transition-all ${activeTab === 'preview' ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30' : processedData ? 'bg-slate-700/50 text-slate-300 hover:bg-slate-700' : 'bg-slate-800/50 text-slate-500 cursor-not-allowed'}">
                            <div class="w-5 h-5">${icons.eye}</div>
                            ตรวจสอบข้อมูล
                        </button>
                        <button onclick="setActiveTab('summary')" class="flex items-center gap-2 px-5 py-2.5 rounded-xl font-medium transition-all ${activeTab === 'summary' ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30' : summaryData ? 'bg-slate-700/50 text-slate-300 hover:bg-slate-700' : 'bg-slate-800/50 text-slate-500 cursor-not-allowed'}">
                            <div class="w-5 h-5">${icons.chart}</div>
                            สรุปรวม
                        </button>
                    </div>

                    <!-- Error Alert -->
                    ${error ? `
                        <div class="mb-6 p-4 bg-red-500/20 border border-red-500/50 rounded-xl flex items-center gap-3">
                            <div class="w-6 h-6 text-red-400">${icons.alert}</div>
                            <span class="text-red-300">${error}</span>
                        </div>
                    ` : ''}

                    ${activeTab === 'upload' ? `
                        <!-- Upload Tab -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Main File -->
                            <div class="lg:col-span-1">
                                <div class="bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-700 p-6 h-full">
                                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <div class="w-5 h-5 text-amber-400">${icons.file}</div>
                                        ไฟล์หลัก (Template)
                                    </h2>
                                    
                                    <label class="block cursor-pointer">
                                        <input type="file" accept=".xlsx,.xls" onchange="handleMainFileSelect(event)" class="hidden">
                                        <div class="border-2 border-dashed rounded-xl p-8 text-center transition-all ${mainFile ? 'border-emerald-500 bg-emerald-500/10' : 'border-slate-600 hover:border-cyan-500 hover:bg-cyan-500/5'}">
                                            ${mainFile ? `
                                                <div class="flex flex-col items-center gap-3">
                                                    <div class="w-12 h-12 text-emerald-500">${icons.check}</div>
                                                    <div>
                                                        <p class="font-medium">${mainFile.name}</p>
                                                        <p class="text-sm text-slate-400">${mainFile.size}</p>
                                                        <p class="text-xs text-slate-500 mt-1">${mainFile.sheets?.length || 0} sheets</p>
                                                    </div>
                                                </div>
                                            ` : `
                                                <div class="w-12 h-12 mx-auto text-slate-500 mb-3">${icons.upload}</div>
                                                <p class="text-slate-300 mb-1">คลิกเพื่อเลือกไฟล์หลัก</p>
                                                <p class="text-sm text-slate-500">.xlsx หรือ .xls</p>
                                            `}
                                        </div>
                                    </label>
                                    
                                    <p class="text-xs text-slate-500 mt-3 text-center">* ไม่จำเป็นต้องมี ระบบจะสร้างไฟล์ใหม่ได้</p>
                                </div>
                            </div>

                            <!-- Source Files -->
                            <div class="lg:col-span-2">
                                <div class="bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-700 p-6">
                                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <div class="w-5 h-5 text-cyan-400">${icons.chart}</div>
                                        ไฟล์ข้อมูลรายโรงงาน
                                    </h2>

                                    <!-- Drop Zone -->
                                    <label class="block cursor-pointer mb-4">
                                        <input type="file" multiple accept=".xlsx,.xls" onchange="handleSourceFilesSelect(event)" class="hidden">
                                        <div class="border-2 border-dashed border-slate-600 rounded-xl p-6 text-center hover:border-cyan-500 hover:bg-cyan-500/5 transition-all">
                                            <div class="w-10 h-10 mx-auto text-slate-500 mb-2">${icons.upload}</div>
                                            <p class="text-slate-300 mb-1">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือก</p>
                                            <p class="text-sm text-slate-500">รองรับ: BP_*, BPK_*, GW_*, SR_* (.xls, .xlsx)</p>
                                        </div>
                                    </label>

                                    <!-- Category Cards -->
                                    <div class="grid grid-cols-4 gap-3 mb-4">
                                        ${['BP', 'BPK', 'GW', 'SR'].map(cat => `
                                            <div class="p-3 rounded-xl border ${getCategoryColor(cat)}">
                                                <div class="text-lg font-bold">${cat}</div>
                                                <div class="text-2xl font-bold">${fileCounts[cat]}</div>
                                                <div class="text-xs opacity-75">ไฟล์</div>
                                            </div>
                                        `).join('')}
                                    </div>

                                    <!-- File List -->
                                    ${sourceFiles.length > 0 ? `
                                        <div class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin">
                                            ${sourceFiles.map((file, i) => `
                                                <div class="flex items-center justify-between bg-slate-700/50 rounded-lg px-4 py-3">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-5 h-5 ${file.status === 'done' ? 'text-emerald-500' : file.status === 'error' ? 'text-red-500' : 'text-slate-400'}">
                                                            ${file.status === 'done' ? icons.check : file.status === 'processing' ? `<div class="animate-spin">${icons.refresh}</div>` : icons.file}
                                                        </div>
                                                        <div>
                                                            <p class="text-sm font-medium">${file.name}</p>
                                                            <p class="text-xs text-slate-400">${file.size} ${file.rowCount ? `• ${file.rowCount} rows` : ''}</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="px-2 py-1 rounded text-xs font-medium border ${getCategoryColor(file.category)}">${file.category}</span>
                                                        <button onclick="removeSourceFile(${i})" class="w-5 h-5 text-slate-400 hover:text-red-400 transition-colors">
                                                            ${icons.trash}
                                                        </button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Process Button -->
                            <div class="lg:col-span-3">
                                <button 
                                    onclick="processAllFiles()"
                                    ${sourceFiles.length === 0 || processing ? 'disabled' : ''}
                                    class="w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-3 transition-all ${sourceFiles.length > 0 && !processing ? 'bg-gradient-to-r from-emerald-500 to-cyan-500 shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50 cursor-pointer' : 'bg-slate-700 text-slate-400 cursor-not-allowed'}"
                                >
                                    ${processing ? `
                                        <div class="w-6 h-6 animate-spin">${icons.refresh}</div>
                                        กำลังประมวลผล...
                                    ` : `
                                        <div class="w-6 h-6">${icons.play}</div>
                                        รวมข้อมูลและคำนวณ
                                    `}
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    ${activeTab === 'preview' && processedData ? `
                        <!-- Preview Tab -->
                        <div class="space-y-4">
                            ${Object.entries(processedData).map(([sheet, rows]) => {
                                const cat = sheet.split(' ')[0];
                                const isExpanded = state.expandedSections[sheet];
                                return `
                                    <div class="bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-700 overflow-hidden">
                                        <button onclick="toggleSection('${sheet}')" class="w-full px-5 py-4 flex items-center justify-between hover:bg-slate-700/30 transition-colors">
                                            <div class="flex items-center gap-3">
                                                <span class="px-3 py-1 rounded-lg text-sm font-medium border ${getCategoryColor(cat)}">${cat}</span>
                                                <span class="font-semibold">${sheet}</span>
                                                <span class="text-slate-400">(${rows.length} รายการ)</span>
                                            </div>
                                            <div class="w-5 h-5 text-slate-400">${isExpanded ? icons.chevronUp : icons.chevronDown}</div>
                                        </button>
                                        
                                        ${isExpanded ? `
                                            <div class="px-5 pb-4 overflow-x-auto scrollbar-thin">
                                                <table class="w-full text-sm">
                                                    <thead>
                                                        <tr class="text-slate-400 border-b border-slate-700">
                                                            <th class="text-left py-3 px-3">Part Number</th>
                                                            <th class="text-left py-3 px-3">Part Code</th>
                                                            <th class="text-right py-3 px-3">Packing</th>
                                                            <th class="text-right py-3 px-3 text-cyan-400">N</th>
                                                            <th class="text-right py-3 px-3 text-emerald-400">N+1</th>
                                                            <th class="text-right py-3 px-3 text-amber-400">N+2</th>
                                                            <th class="text-right py-3 px-3 text-purple-400">N+3</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${rows.slice(0, 50).map(row => `
                                                            <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                                <td class="py-2 px-3 font-mono text-cyan-400">${row.partNumber}</td>
                                                                <td class="py-2 px-3 text-slate-300">${row.partCode}</td>
                                                                <td class="py-2 px-3 text-right text-slate-300">${row.packingSize}</td>
                                                                <td class="py-2 px-3 text-right font-medium">${formatNumber(row.n)}</td>
                                                                <td class="py-2 px-3 text-right">${formatNumber(row.n1)}</td>
                                                                <td class="py-2 px-3 text-right">${formatNumber(row.n2)}</td>
                                                                <td class="py-2 px-3 text-right">${formatNumber(row.n3)}</td>
                                                            </tr>
                                                        `).join('')}
                                                        ${rows.length > 50 ? `
                                                            <tr class="text-slate-500 text-center">
                                                                <td colspan="7" class="py-3">... และอีก ${rows.length - 50} รายการ</td>
                                                            </tr>
                                                        ` : ''}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}

                    ${activeTab === 'summary' && summaryData ? `
                        <!-- Summary Tab -->
                        <div class="space-y-6">
                            <!-- Summary Cards -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl p-5 shadow-lg shadow-cyan-500/20">
                                    <p class="text-white/80 text-sm">N (Feb)</p>
                                    <p class="text-3xl font-bold">${formatNumber(totals.n)}</p>
                                    <p class="text-white/60 text-xs mt-1">ชิ้น</p>
                                </div>
                                <div class="bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl p-5 shadow-lg shadow-emerald-500/20">
                                    <p class="text-white/80 text-sm">N+1 (Mar)</p>
                                    <p class="text-3xl font-bold">${formatNumber(totals.n1)}</p>
                                    <p class="text-white/60 text-xs mt-1">ชิ้น</p>
                                </div>
                                <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 shadow-lg shadow-amber-500/20">
                                    <p class="text-white/80 text-sm">N+2 (Apr)</p>
                                    <p class="text-3xl font-bold">${formatNumber(totals.n2)}</p>
                                    <p class="text-white/60 text-xs mt-1">ชิ้น</p>
                                </div>
                                <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-5 shadow-lg shadow-purple-500/20">
                                    <p class="text-white/80 text-sm">N+3 (May)</p>
                                    <p class="text-3xl font-bold">${formatNumber(totals.n3)}</p>
                                    <p class="text-white/60 text-xs mt-1">ชิ้น</p>
                                </div>
                            </div>

                            <!-- Summary Table -->
                            <div class="bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-700 overflow-hidden">
                                <div class="px-6 py-4 border-b border-slate-700">
                                    <h3 class="font-semibold flex items-center gap-2">
                                        <div class="w-5 h-5 text-emerald-400">${icons.chart}</div>
                                        สรุปยอดรวมตาม Part Number (${summaryData.length} รายการ)
                                    </h3>
                                </div>
                                <div class="overflow-x-auto scrollbar-thin">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="bg-slate-700/50">
                                                <th class="text-left py-3 px-4 font-medium">Part Number</th>
                                                <th class="text-left py-3 px-4 font-medium">Plants</th>
                                                <th class="text-right py-3 px-4 font-medium text-cyan-400">N</th>
                                                <th class="text-right py-3 px-4 font-medium text-emerald-400">N+1</th>
                                                <th class="text-right py-3 px-4 font-medium text-amber-400">N+2</th>
                                                <th class="text-right py-3 px-4 font-medium text-purple-400">N+3</th>
                                                <th class="text-right py-3 px-4 font-medium">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${summaryData.map(row => `
                                                <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td class="py-3 px-4 font-mono text-cyan-400">${row.partNumber}</td>
                                                    <td class="py-3 px-4">
                                                        <div class="flex gap-1 flex-wrap">
                                                            ${row.plants.split(', ').map(p => `<span class="px-2 py-0.5 rounded text-xs border ${getCategoryColor(p)}">${p}</span>`).join('')}
                                                        </div>
                                                    </td>
                                                    <td class="py-3 px-4 text-right text-cyan-400 font-medium">${formatNumber(row.n)}</td>
                                                    <td class="py-3 px-4 text-right text-emerald-400">${formatNumber(row.n1)}</td>
                                                    <td class="py-3 px-4 text-right text-amber-400">${formatNumber(row.n2)}</td>
                                                    <td class="py-3 px-4 text-right text-purple-400">${formatNumber(row.n3)}</td>
                                                    <td class="py-3 px-4 text-right font-bold">${formatNumber(row.n + row.n1 + row.n2 + row.n3)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr class="bg-slate-700/50 font-bold">
                                                <td class="py-4 px-4">Grand Total</td>
                                                <td class="py-4 px-4 text-slate-400">${summaryData.length} Parts</td>
                                                <td class="py-4 px-4 text-right text-cyan-400">${formatNumber(totals.n)}</td>
                                                <td class="py-4 px-4 text-right text-emerald-400">${formatNumber(totals.n1)}</td>
                                                <td class="py-4 px-4 text-right text-amber-400">${formatNumber(totals.n2)}</td>
                                                <td class="py-4 px-4 text-right text-purple-400">${formatNumber(totals.n3)}</td>
                                                <td class="py-4 px-4 text-right">${formatNumber(totals.n + totals.n1 + totals.n2 + totals.n3)}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <!-- Download Button -->
                            <button onclick="exportToExcel()" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-xl font-semibold text-lg flex items-center justify-center gap-3 shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50 transition-all">
                                <div class="w-6 h-6">${icons.download}</div>
                                ดาวน์โหลดไฟล์ Excel สรุป
                            </button>
                        </div>
                    ` : ''}

                    ${(activeTab === 'preview' || activeTab === 'summary') && !processedData ? `
                        <!-- Empty State -->
                        <div class="text-center py-20">
                            <div class="w-20 h-20 mx-auto text-slate-600 mb-4">${icons.alert}</div>
                            <h3 class="text-xl text-slate-400 mb-2">ยังไม่มีข้อมูล</h3>
                            <p class="text-slate-500 mb-4">กรุณาอัปโหลดไฟล์และประมวลผลก่อน</p>
                            <button onclick="setActiveTab('upload')" class="px-6 py-2 bg-slate-700 rounded-lg hover:bg-slate-600 transition-colors">
                                ไปหน้าอัปโหลด
                            </button>
                        </div>
                    ` : ''}
                </main>

                <!-- Footer -->
                <footer class="border-t border-slate-700 mt-12 py-6">
                    <div class="max-w-7xl mx-auto px-4 text-center text-slate-500 text-sm">
                        Production Data Consolidator v1.0 • TMT Camera Production Plan Summary System
                    </div>
                </footer>
            `;
        };

        // Initial render
        render();
    </script>
</body>
</html>
